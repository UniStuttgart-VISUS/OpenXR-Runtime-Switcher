<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

    <!-- Product version which must be incremented for each release. -->
    <?define ProductVersion = 1.0.0.0?>

    <!-- Platform magic trick from https://stackoverflow.com/questions/18628790/build-wix-3-6-project-targeting-x64. -->
    <!-- https://stackoverflow.com/questions/18628790/build-wix-3-6-project-targeting-x64 -->
    <?if $(var.Platform) = x64 ?>
        <?define PlatformProgrammeFilesFolder = "ProgramFiles64Folder" ?>
        <?define Win64 = "yes" ?>
    <?else ?>
        <?define PlatformProgrammeFilesFolder = "ProgramFilesFolder" ?>
        <?define Win64 = "no" ?>
    <?endif ?>

    <Product Id="*"
             Name="!(loc.ProductName)"
             Language="!(loc.LanguageCode)"
             Version="$(var.ProductVersion)"
             Manufacturer="!(loc.ManufacturerName)"
             UpgradeCode="62423a1b-13dd-4a48-b643-efaba89f978d">

        <!-- Package details -->
        <Package InstallerVersion="301"
                 Compressed="yes"
                 Platform="x64"
                 InstallScope="perMachine"
                 Manufacturer="!(loc.ManufacturerName)"
                 Description="!(loc.ProductDescription)" />

        <!-- Downgrade error message -->
        <MajorUpgrade AllowDowngrades="no" DowngradeErrorMessage="!(loc.DowngradeErrorMessage)" />

        <!-- Package CAB into MSI -->
        <MediaTemplate EmbedCab="yes" />

        <!-- User interface -->
        <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)licence.rtf" />
        <UIRef Id="WixUI_FeatureTree" />

        <!-- Features to be installed -->
        <Feature Id="ProductFeature" Title="!(loc.ProductName)" Absent="disallow" Display="expand" Level="1">
            <ComponentGroupRef Id="CmpOxrSwitcher" />
            <Feature Id="ServiceFeature" Title="!(loc.ServiceFeature)" Absent="allow" Level="1">
                <ComponentGroupRef Id="CmpOxrSvc" />
            </Feature>
            
        </Feature>

        <Feature Id="VisualCppRuntime" Title="!(loc.VisualCppRuntime)" AllowAdvertise="no" Display="hidden" Level="1">
            <!--<MergeRef Id="VisualCppRuntime"/>-->
        </Feature>
    </Product>

    <Fragment>
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="$(var.PlatformProgrammeFilesFolder)">
                <Directory Id="VisusProgrammeFolder" Name="VISUS">
                    <Directory Id="OxrSwitchProgrammeFolder" Name="OpenXR Switcher" />
                </Directory>
            </Directory>

            <Directory Id="ProgramMenuFolder"></Directory>
        </Directory>
    </Fragment>

    <Fragment>
        <Icon Id="$(var.oxrswitch.TargetFileName)" SourceFile="$(var.oxrswitch.TargetPath)" />
    </Fragment>

    <!-- 
    <Fragment>
        <DirectoryRef Id="TARGETDIR">
            <Merge Id="VisualCppRuntime" SourceFile="$(var.ProjectDir)Microsoft_VC142_CRT_x64.msm" DiskId="1" Language="0"/>
        </DirectoryRef>
    </Fragment>
    -->

    <Fragment>
        <!-- Deploys the executable -->
        <ComponentGroup Id="CmpOxrSwitcher" Directory="OxrSwitchProgrammeFolder">
            <Component Id="OxrSwitchApp" Guid="{0563570E-D464-4E77-B41C-51A59847F40D}">
                <File Id="$(var.oxrswitch.TargetFileName)" KeyPath="yes" Source="$(var.oxrswitch.TargetPath)">
                    <Shortcut Id="OxrSwitchShortcut" Directory="ProgramMenuFolder" Name="!(loc.ProductName)" WorkingDirectory="INSTALLDIR" Icon="$(var.oxrswitch.TargetFileName)" IconIndex="0" Advertise="yes" />
                </File>
            </Component>
        </ComponentGroup>

        <!-- Deploys the service -->
        <ComponentGroup Id="CmpOxrSvc" Directory="OxrSwitchProgrammeFolder">
            <Component Id="OxrSvcApp" Guid="{E8814975-CA1A-4E6B-BF86-C1943C6D11A1}">
                <File Id="$(var.oxrsvc.TargetFileName)" KeyPath="yes" Source="$(var.oxrsvc.TargetPath)" />
                <ServiceInstall Id="OxrSvc" Name="oxrsvc" Description="!(loc.ServiceDescription)" DisplayName="!(loc.ServiceName)" Account="LocalSystem" ErrorControl="normal" Start="auto" Type="ownProcess" Vital="no" />
                <ServiceControl Id="OxrSvc" Name="oxrsvc" Start="install" Stop="both" Remove="uninstall" Wait="yes" />
                <ServiceConfig Id="OxrSvc" ServiceName="oxrsvc" OnInstall="yes" DelayedAutoStart="yes" />
            </Component>
        </ComponentGroup>
    </Fragment>
</Wix>
