<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

    <!-- Product version which must be incremented for each release. -->
    <?define ProductVersion = 1.0.0.0?>

    <!-- Platform magic trick from https://stackoverflow.com/questions/18628790/build-wix-3-6-project-targeting-x64. -->
    <?if $(var.Platform) = x64 ?>
    <?define Win64 = "yes" ?>
    <?define PlatformProgrammeFilesFolder = "ProgramFiles64Folder" ?>
    <?else ?>
    <?define Win64 = "no" ?>
    <?define PlatformProgrammeFilesFolder = "ProgramFilesFolder" ?>
    <?endif ?>

    <Product Id="*"
             Name="!(loc.ProductName)"
             Language="!(loc.LanguageCode)"
             Version="$(var.ProductVersion)"
             Manufacturer="!(loc.ManufacturerName)"
             UpgradeCode="62423a1b-13dd-4a48-b643-efaba89f978d">

        <!-- Package details -->
        <Package InstallerVersion="301"
                 Compressed="yes"
                 Platform="x64"
                 InstallScope="perMachine"
                 Manufacturer="!(loc.ManufacturerName)"
                 Description="!(loc.ProductDescription)" />

        <!-- Downgrade error message -->
        <MajorUpgrade AllowDowngrades="no" DowngradeErrorMessage="!(loc.DowngradeErrorMessage)" />

        <!-- Package CAB into MSI -->
        <MediaTemplate EmbedCab="yes" />

        <!-- User interface -->
        <UIRef Id="WixUI_Minimal" />
        <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)licence.rtf" />

        <!-- Features to be installed -->
        <Feature Id="ProductFeature" Title="!(loc.ProductName)" Level="1">
            <ComponentGroupRef Id="ProductComponents" />
            <!--<ComponentGroupRef Id="ScheduledTask" />
            <ComponentGroupRef Id="RegistryEntries" />-->
        </Feature>

        <Feature Id="VisualCppRuntime" Title="!(loc.VisualCppRuntime)" AllowAdvertise="no" Display="hidden" Level="1">
            <!--<MergeRef Id="VisualCppRuntime"/>-->
        </Feature>
    </Product>

    <Fragment>
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="$(var.PlatformProgrammeFilesFolder)">
                <Directory Id="VisusProgrammeFolder" Name="VISUS">
                    <Directory Id="OxrSwitchProgrammeFolder" Name="OpenXR Switcher" />
                </Directory>
            </Directory>
        </Directory>
    </Fragment>

    <!-- 
    <Fragment>
        <DirectoryRef Id="TARGETDIR">
            <Merge Id="VisualCppRuntime" SourceFile="$(var.ProjectDir)Microsoft_VC142_CRT_x64.msm" DiskId="1" Language="0"/>
        </DirectoryRef>
    </Fragment>
    -->

    <Fragment>
        <!-- Deploys the executable -->
        <ComponentGroup Id="ProductComponents" Directory="OxrSwitchProgrammeFolder">
            <Component Id="OxrSwitchApp" Guid="{0563570E-D464-4E77-B41C-51A59847F40D}">
                <File Id="$(var.oxrswitch.TargetFileName)" KeyPath="yes" Source="$(var.oxrswitch.TargetPath)" />
            </Component>
        </ComponentGroup>
    </Fragment>

    <Fragment>
        <!-- This fragment creates a scheduled task that runs the tool as system. -->
        <CustomAction Id="CreateScheduledTask"
                      Property="CreateScheduledTask"
                      Return="check"
                      Execute="immediate"
                      Value="&quot;[SystemFolder]schtasks.exe&quot; /create /sc once /sd 01/01/1943 /st 00:00 /tn &quot;SwitchOpenXrRuntime&quot; /tr &quot;'[OxrSwitchProgrammeFolder]$(var.oxrswitch.TargetFileName)'&quot; /ru &quot;SYSTEM&quot; /rl HIGHEST /it" />
        <CustomAction Id="DeleteScheduledTask"
                      Property="DeleteScheduledTask"
                      Return="check"
                      Execute="immediate"
                      Value="&quot;[SystemFolder]schtasks.exe&quot; /delete /tn &quot;SwitchOpenXrRuntime&quot;" />

        <InstallExecuteSequence>
            <Custom Action="CreateScheduledTask" After="InstallFinalize">NOT Installed</Custom>
            <Custom Action="DeleteScheduledTask" Before="RemoveFiles">Installed</Custom>
        </InstallExecuteSequence>
    </Fragment>
</Wix>
